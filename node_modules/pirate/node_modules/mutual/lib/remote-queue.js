// Generated by CoffeeScript 1.7.1
(function() {
  var RemoteChannel, RemoteQueue,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  RemoteChannel = require("./remote-channel");

  RemoteQueue = (function(_super) {
    __extends(RemoteQueue, _super);

    function RemoteQueue() {
      return RemoteQueue.__super__.constructor.apply(this, arguments);
    }

    RemoteQueue.prototype.send = function(message) {
      return this.events.source((function(_this) {
        return function(events) {
          var _events;
          _events = _this.transport.enqueue(_this["package"](message));
          return _events.forward(events);
        };
      })(this));
    };

    RemoteQueue.prototype.listen = function() {
      return this.events.source((function(_this) {
        return function(events) {
          var _dequeue;
          if (!_this.isListening) {
            _this.isListening = true;
            _dequeue = function() {
              return _this.transport.dequeue(_this.name).on("success", function(message) {
                var _ref, _ref1;
                _this.fire(message);
                if (((_ref = _this.channels[message.event]) != null ? (_ref1 = _ref.handlers) != null ? _ref1.length : void 0 : void 0) > 0) {
                  return setImmediate(_dequeue);
                }
              });
            };
            if (_this.superOn == null) {
              _this.superOn = _this.on;
            }
            _this.on = function(event, handler) {
              if (event !== "success" && event !== "error" && event !== "ready") {
                _this.superOn(event, handler);
                return _dequeue();
              }
            };
            return events.emit("success");
          }
        };
      })(this));
    };

    return RemoteQueue;

  })(RemoteChannel);

  module.exports = RemoteQueue;

}).call(this);
